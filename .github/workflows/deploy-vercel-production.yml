name: Deploy to Production (Vercel)

# Trigger: manual only with branch selection
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy from'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - main

jobs:
  deploy-production:
    name: Deploy to Vercel Production
    environment: production
    runs-on: ubuntu-latest
    permissions:
      contents: write       # Required for: git push, git tag push
      actions: read         # Required for: workflow execution

    steps:
      # Step 1: Checkout selected branch
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0 # Full history for git log (release notes)

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 4: Run ESLint (quality gate)
      - name: Run ESLint
        run: npm run lint

      # Step 5: Run unit tests (quality gate - CRITICAL)
      - name: Run unit tests
        run: npm run test:unit

      # Step 6: Calculate next tag version
      - name: Calculate next tag version
        id: tag
        run: |
          # Get latest tag matching v*.*.* pattern
          LATEST_TAG=$(git tag -l "v*.*.*" | sort -V | tail -n1)

          if [ -z "$LATEST_TAG" ]; then
            # No tags exist, start with v1.0.0
            NEW_TAG="v1.0.0"
          else
            # Extract version numbers
            VERSION=${LATEST_TAG#v}
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)
            PATCH=$(echo $VERSION | cut -d. -f3)

            # Increment patch version
            NEW_PATCH=$((PATCH + 1))
            NEW_TAG="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          fi

          echo "previous_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "new_tag=${NEW_TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ New version: ${NEW_TAG} (previous: ${LATEST_TAG:-none})"

      # Step 7: Create and push tag
      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.tag.outputs.new_tag }}
          git push origin ${{ steps.tag.outputs.new_tag }}
          echo "âœ… Tag ${{ steps.tag.outputs.new_tag }} created and pushed"

      # Step 8: Deploy to Vercel (Production)
      - name: Deploy to Vercel (Production)
        run: npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      # Step 9: Create GitHub Release
      - name: Create GitHub Release
        run: |
          gh release create ${{ steps.tag.outputs.new_tag }} \
            --title "Release ${{ steps.tag.outputs.new_tag }}" \
            --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 10: Summary
      - name: Deployment summary
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸŒ¿ Branch: ${{ inputs.branch }}"
          echo "ğŸ“¦ Version: ${{ steps.tag.outputs.new_tag }}"
          echo "ğŸŒ Vercel: https://10xcards.vercel.app"
          echo "ğŸ“‹ GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.new_tag }}"
